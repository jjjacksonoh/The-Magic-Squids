-- QUESTION 1
SELECT * FROM data_officerassignmentattendance



-- QUESTION 2
CREATE TEMP TABLE allegations_per_beat AS
    SELECT COUNT(beat_id) AS total_allegations, beat_id
    FROM data_allegation da
    GROUP BY da.beat_id;

CREATE TEMP TABLE allegations_per_beat_poly AS
    SELECT total_allegations, beat_id, polygon
    FROM allegations_per_beat apb
        JOIN data_area da ON beat_id = da.id
    ORDER BY beat_id;

CREATE TEMP TABLE allegations_per_district AS
    SELECT SUM(total_allegations) AS total_allegations, da.id AS district_id
    FROM allegations_per_beat_poly apb
        JOIN data_area da ON st_intersects(da.polygon, apb.polygon)
    WHERE da.area_type = 'police-districts'
    GROUP BY da.id
    ORDER BY da.id;

SELECT total_allegations / total_residents as allegations_per_capita, district_id
FROM allegations_per_district apd
    JOIN total_population tp ON tp.area_id = apd.district_id;
    
    

-- QUESTION 3
CREATE TEMP TABLE total_population AS
    SELECT SUM(count) AS total_residents, area_id
    FROM data_racepopulation drp
        JOIN data_area da ON drp.area_id = da.id
    WHERE da.area_type = 'police-districts'
    GROUP BY drp.area_id
    ORDER BY drp.area_id;

CREATE TEMP TABLE black_population AS
    SELECT count AS black_residents, area_id
    FROM data_racepopulation drp
        JOIN data_area da ON drp.area_id = da.id
    WHERE drp.race = 'Black' AND da.area_type = 'police-districts'
    ORDER BY drp.area_id;

SELECT black_residents, total_residents, area_id
FROM black_population bp
    JOIN total_population tp on bp.area_id = tp.area_id
ORDER BY tp.area_id;



-- QUESTION 4
CREATE TEMP TABLE number_of_allegations AS
    SELECT
           COUNT(da.beat_id) AS total_allegation_type,
           da.most_common_category_id, da.beat_id, dac.id, dac.category, dac.allegation_name
    FROM data_allegation da
    JOIN data_allegationcategory dac
    ON da.most_common_category_id = dac.id
    GROUP BY da.beat_id, dac.allegation_name, da.most_common_category_id, da.beat_id, dac.id, dac.category, dac.allegation_name
    ORDER BY da.beat_id;

SELECT beat_id, MAX(total_allegation_type), MAX(allegation_name) AS allegation_name, MAX(id) AS id
FROM number_of_allegations
GROUP BY beat_id
ORDER BY beat_id
